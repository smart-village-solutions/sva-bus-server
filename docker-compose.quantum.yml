services:
  bus-api:
    image: ${IMAGE_REF}
    environment:
      PORT: '3000'
      LOG_LEVEL: ${LOG_LEVEL:-info}
      HTTP_CLIENT_BASE_URL: ${HTTP_CLIENT_BASE_URL}
      HTTP_CLIENT_API_KEY: ${HTTP_CLIENT_API_KEY:-}
      ADMIN_API_TOKEN: ${ADMIN_API_TOKEN:-}
      HTTP_CLIENT_TIMEOUT: ${HTTP_CLIENT_TIMEOUT:-10000}
      HTTP_CLIENT_RETRIES: ${HTTP_CLIENT_RETRIES:-2}
      PROXY_BODY_LIMIT: ${PROXY_BODY_LIMIT:-1048576}
      CACHE_REDIS_URL: redis://redis:6379
      CACHE_TTL_DEFAULT: ${CACHE_TTL_DEFAULT:-300}
      CACHE_STALE_TTL: ${CACHE_STALE_TTL:-60}
      CACHE_IGNORE_UPSTREAM_CONTROL: ${CACHE_IGNORE_UPSTREAM_CONTROL:-false}
      CACHE_BYPASS_PATHS: ${CACHE_BYPASS_PATHS:-/health}
      CACHE_DEBUG: ${CACHE_DEBUG:-false}
    networks:
      - public
      - cache

  redis:
    image: redis:7-alpine
    command: ['redis-server', '--save', '60', '1', '--appendonly', 'yes']
    volumes:
      - redis-data:/data
    networks:
      - cache

volumes:
  redis-data:

networks:
  public:
    external: true
  cache:
